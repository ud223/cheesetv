<script type="text/javascript" src="<?php echo $this->jsPath('player.js'); ?>"></script>
<script type="text/javascript" src="<?php echo $this->jsPath('qrcode.js'); ?>"></script>


<?php
$player_mode = "video";
if ($this->me) {
    if ($this->me->getUser()->attribute && $this->me->getUser()->attribute['player_mode']) {
        $player_mode = $this->me->getUser()->attribute['player_mode'];
    }
}
$bean = $this->resource;
$programs = $bean['programs'];
?>


<div id="tv-main-container" class="layer">
    <div id='tv-sider'>
        <div class="pxt">
            <button id='btn-refresh' onclick="location.href = '<?php echo $this->url(array(), 'show-play') ?>'" class='ico tv-side-btn'></button>
            <button id='btn-list' class='ico tv-side-btn'></button>
            <?php if ($player_mode == 'video'): ?>
                <button id='btn-toggle-audio' rel="audio" class='ico tv-side-btn'></button>
            <?php else: ?>
                <button id='btn-toggle-video' rel="video" class='ico tv-side-btn'></button>
            <?php endif; ?>
        </div>
    </div>
    <div id="tv-listbar" sid="<?php echo $bean['id'] ?>">
        <div class="tv-tab-content">
            <div class="tv-tab-content-head">
                <div class="alt alt-list">
                    <img class="alt-img" src="<?php echo $bean['photo'] ?>"/>
                    <div class="alt-title">
                        <p class="t1"><?php echo $bean['name'] ?></p>
                        <div class="t2">by <?php echo $bean['author'] ?></div>
                    </div>
                    <div class="alt-opera">
                        <?php if ($this->me): ?>
                            <button class="ico" id="add-to-favor"></button>
                        <?php endif; ?>
                    </div>
                </div>
                <div class="alt alt-favor hidden">
                    <div class="alt-title">
                        <p class="t1">我的收藏夹</p>
                        <div class="t2">已收藏 <span></span> 个专辑</div>
                    </div>
                </div>
                <div class="alt alt-hobby hidden">
                    <div class="alt-title">
                        <p class="t1">设置兴趣</p>
                        <div class="t2">根据您的兴趣推送节目</div>
                    </div>
                </div>
                <div class="clear"></div>
            </div>
            <div class="tv-tab-content-body">
                <div class="alt alt-list">
                    <?php foreach ($programs as $program): ?>
                        <?php
                        $cls = "";
                        if ($this->cur_program['id'] == $program['id']) {
                            $cls = " selected";
                        }
                        ?>
                        <div class="list-item clearfix<?php echo $cls ?>" id="<?php echo $program['id'] ?>">
                            <div class="list-item-cell lt"><?php echo $program['name'] ?></div>
                            <div class="list-item-cell rt sharing ico"></div>
                            <div class="list-item-cell rt duration" time="<?php echo $program['time'] ?>"></div>
                        </div>
                    <?php endforeach; ?>
                </div>


                <?php if ($this->me): ?>
                    <div class="alt alt-favor hidden">

                    </div>
                    <div class="alt alt-hobby hidden">

                    </div>
                <?php endif; ?>
            </div>
        </div>
        <div class="tv-tab-list">
            <ul>
                <li id="list" loaded="true" class="tv-tab-list-item selected">
                    <span>专辑播放列表</span>
                </li>
                <?php if ($this->me): ?>
                    <li id="favor" class="tv-tab-list-item">
                        <span>我的收藏夹</span>
                    </li>
                    <li id="hobby" class="tv-tab-list-item">
                        <span>兴趣设置</span>
                    </li>
                <?php endif; ?>
            </ul>
            <?php if ($this->me): ?>
                <div class="logout-btn-content">
                    <button class="btn btn-gray btn-sm" id="logout-btn">安全退出</button>
                </div>
            <?php endif; ?>
        </div>
        <button id="tv-tab-close"><i class="ico"></i></button>
    </div>

    <?php if ($player_mode == 'video'): ?>
        <div id="tv-screen" class="layer text-center">
            <video id="tv-video-player" src="<?php echo $this->cur_program['oss_video'] ?>" preload autoplay="autoplay" oncontextmenu="return false;">
            </video>
        </div>
    <?php else: ?>
        <div id="tv-disk">
            <div id="tv-disk-page"></div>
        </div>
        <audio id="tv-video-player" src="<?php echo $this->cur_program['oss_audio'] ?>" preload autoplay="autoplay"></audio>
    <?php endif; ?>

    <div id="tv-ctrl-block">
        <div id="tv-ctrl-c">
            <span id="tv-ctrl-st">00:00</span>
            <span id="tv-ctrl-ct">00:00</span>
            <div id="tv-ctrl-prog">
            </div>
        </div>
        <div id="tv-ctrl-play" class="tv-ctrl-s">
            <i class="ico"></i>
        </div>
        <div id="tv-ctrl-pause" class="tv-ctrl-s">
            <i class="ico"></i>
        </div>
        <div id="tv-ctrl-fullscreen" full='no' class="tv-ctrl-s">
            <i class="ico"></i>
        </div>
    </div>

</div>

<div class="P_tmp">

    <div class="list-item clearfix favor-item">
        <div class="list-item-cell lt"></div>
        <div class="list-item-cell rt sharing ico"></div>
        <div class="list-item-cell rt remove-favor ico"></div>
    </div>


    <div class="unit-item hobby-item">
        <p></p>
    </div>

    <div class="sharing-popup">
        <button class="btn btn-sm hide-qrcode">&lt; 返回</button>
        <div class="ctss">
            <div class="cts-1">
                <p>
                    分享 <span></span>
                </p>
                <a class="sharing-ico weixin" href="javascript:void(0)"><i></i> 微信扫一扫</a>
                <div class="clear"></div>
                <a class="sharing-ico weibo" href="#"><i></i> 分享到新浪微博</a>
                <div class="clear"></div>
                <a class="sharing-ico qqweibo" href="#"><i></i> 分享到腾讯微博</a>
                <div class="clear"></div>
            </div>
            <div class="cts-2">
                <div class="qr"></div>
            </div>
        </div>
    </div>

</div>



<!--<button id="seeking-testing-btn" style="position:fixed;z-index:100;bottom:100px;left:100px;padding:10px;">SEEKING BTN</button>-->

<script type="text/javascript">
    var init_player_mode = '<?php echo $player_mode; ?>';
    var PLAYER = document.getElementsByTagName(init_player_mode)[0];
    $('document').ready(function() {
        // set interval per second
        setInterval(function() {
            $('#tv-ctrl-prog').css('width', (PLAYER.currentTime / PLAYER.duration) * 100 + '%');
            if (!isNaN(PLAYER.duration) && !isNaN(PLAYER.currentTime)) {
                $('#tv-ctrl-st').html(PLAYER.duration.timeFormat());
                $('#tv-ctrl-ct ').html(PLAYER.currentTime.timeFormat());
            }
        }, 100);

        $('#tv-ctrl-fullscreen').click(function() {
            switchFullscreen();
        });

        $('#tv-ctrl-c').click(function() {
            clickSeek($('#tv-ctrl-c'));
        });

        $('#btn-list').click(function() {
            $('#tv-listbar').toggle();
            $(this).toggleClass('selected');
        });

        $('#tv-tab-close').click(function() {
            $('#btn-list').click();
        });

        $('#logout-btn').click(function() {
            $.confirm({
                msg: '确定登出吗？',
                confirmCallback: function() {
                    location.href = "<?php echo $this->url(array(), 'logout') ?>";
                },
                containerBoxSelector: '#tv'
            });
        });

        $(PLAYER).on('ended', function() {
            // next program
            var current = $('.tv-tab-content-body .list-item.selected');
            if (current.length) {
                var next = current.next();
                if (next.length) {
                    location.href = "<?php echo $this->url(array(), 'show-play') ?>?special=" + $('#tv-listbar').attr('sid') + "&&program=" + next.attr('id');
                } else {
                    location.href = "<?php echo $this->url(array(), 'show-play') ?>";
                }
            }
        });

        $.each($('.duration'), function() {
            var $this = $(this);
            var time = parseInt($this.attr('time'));
            var timeStr = time.timeFormat();
            $this.html(timeStr);
        });

        if ($('#add-to-favor').length) {
            $.ajax({
                url: '<?php echo $this->url(array(), 'api-favourite-is') ?>',
                dataType: 'json',
                type: 'post',
                data: {sid: $('#tv-listbar').attr('sid')},
                success: function(response) {
                    if (response.code === 200) {
                        $('#add-to-favor').addClass('selected');
                    }
                }
            });
        }
    });

    // 网速失速
    $('#player').on('stalled', function() {
        console.log('stalled');
        var new_one = $('#player').clone(true);
        $('#player').after(new_one).remove();
    });
    // 网速错误
    $('#player').on('error', function() {
        console.log('error');
        var new_one = $('#player').clone(true);
        $('#player').after(new_one).remove();
    });
    var list = [
        {htmlObject: $('#tv-sider')},
        {htmlObject: $('#tv-ctrl-block')}
    ];
    $('#tv-sider, #tv-ctrl-block, #tv-listbar').mouseenter(function() {
        $.autoToggleListStop();
    });
    $('#tv-sider, #tv-ctrl-block, #tv-listbar').mouseleave(function() {
        $.autoToggleListRestart();
    });
    $.autoToggleList(list);

    $('#tv-ctrl-play').click(function() {
        PLAYER.play();
        $('#tv-ctrl-play').toggle();
        $('#tv-ctrl-pause').toggle();
    });
    $('#tv-ctrl-pause').click(function() {
        PLAYER.pause();
        $('#tv-ctrl-play').toggle();
        $('#tv-ctrl-pause').toggle();
    });

    $('.alt-list .list-item').click(function() {
        var programId = $(this).closest('.list-item').attr('id');
        var specialId = $('#tv-listbar').attr('sid');
        var url = "<?php echo $this->url(array(), 'show-play') ?>?special=" + specialId + "&&program=" + programId;
        location.href = url;
    });

    var page_prefix = "<?php echo $this->serverUrl() ?>";
    $('.alt-list .list-item .sharing').click(function() {
        return sharingIt($(this), page_prefix);
    });
    $('.tv-tab-list-item').click(function() {
        // 翻页
        var $this = $(this).closest('.tv-tab-list-item');
        if ($this.hasClass('.selected')) {
            return;
        }
        $('.tv-tab-list-item').removeClass('selected');
        $this.addClass('selected');
        var id = $this.attr('id');
        $('.alt').addClass('hidden');
        $('.alt-' + id).removeClass('hidden');

        if ($this.attr('loaded') !== 'true') {
            $.waiting("读取中 ...");
            switch (id) {
                case 'list':
                    break;
                case 'favor':
                    var url = '<?php echo $this->url(array(), 'api-favourite-list') ?>';
                    $.ajax({
                        url: url,
                        dataType: 'json',
                        type: 'get',
                        success: function(response) {
                            if (response.code === 200) {
                                var body = $('.tv-tab-content-body .alt-favor');
                                body.empty();
                                var header = $('.tv-tab-content-head .alt-favor');
                                header.find('.t2 span').html('0');
                                if (response.data && response.data.specials && response.data.specials.length) {
                                    
                                    header.find('.t2 span').html(response.data.specials.length);

                                    $.each(response.data.specials, function() {
                                        var html = $('.P_tmp .favor-item').clone(true);
                                        html.attr('sid', this.id).find('.list-item-cell.lt').html(this.name);
                                        html.find('.remove-favor').click(function() {
                                            var $this = $(this);
                                            var sid = $this.closest('.list-item').attr('sid');
                                            removeFavor(sid, function() {
                                                $('.list-item[sid="' + sid + '"]').remove();
                                                if (sid === $('#tv-listbar').attr('sid')) {
                                                    $('#add-to-favor').removeClass('selected');
                                                }
                                                var ci = parseInt(header.find('.t2 span').html());
                                                if (ci) {
                                                    header.find('.t2 span').html(ci - 1);
                                                }
                                            });
                                            return false;
                                        });
                                        html.find('.sharing').click(function() {
                                            return sharingIt($(this));
                                        });
                                        html.click(function() {
                                            var $this = $(this).closest('.list-item');
                                            var sid = $this.attr('sid');
                                            var url = "<?php echo $this->url(array(), 'show-play') ?>?special=" + sid;
                                            location.href = url;
                                        });
                                        body.append(html);
                                    });

                                    $this.attr('loaded', 'true');
                                }
                            }
                            $.endWaiting();
                        }
                    });
                    break;
                case 'hobby':
                    var url = '<?php echo $this->url(array(), 'api-user-category-list') ?>';
                    $.ajax({
                        url: url,
                        dataType: 'json',
                        type: 'post',
                        success: function(response) {
                            if (response.code === 200) {
                                var body = $('.tv-tab-content-body .alt-hobby');
                                body.empty();
                                if (response.data && response.data && response.data.length) {
                                    body.append($('<div>').addClass('unit-items'));
                                    $.each(response.data, function() {
                                        var html = $('.P_tmp .hobby-item').clone(true);
                                        html.attr('cid', this.id).find('p').html(this.name);
                                        html.click(function() {
                                            $(this).closest('.unit-item').toggleClass('selected');
                                            var arr = new Array();
                                            var categories = 'none';
                                            if ($('.unit-item.selected').length) {
                                                $.each($('.unit-item.selected'), function() {
                                                    var $this = $(this).closest('.unit-item');
                                                    arr.push($this.attr('cid'));
                                                });
                                                categories = arr.join(';');
                                            }
<?php if ($this->me): ?>
                                                var data = {
                                                    uid: '<?php echo $this->me->getUser()->id ?>',
                                                    category: categories
                                                };
                                                $.waiting(null, $('#tv'));
                                                $.ajax({
                                                    url: '<?php echo $this->url(array(), 'api-user-category-save') ?>',
                                                    dataType: 'json',
                                                    type: 'post',
                                                    data: data,
                                                    complete: function() {
                                                        $.endWaiting();
                                                    }
                                                });
<?php endif ?>
                                        });
                                        if (this.like) {
                                            html.addClass('selected');
                                        }
                                        body.find('.unit-items').append(html);
                                    });
                                    $this.attr('loaded', 'true');
                                }
                            }
                            $.endWaiting();
                        }
                    });
                    break;
            }
        }
    });

    $('#add-to-favor').click(function() {
        var $this = $(this);
        var sid = $('#tv-listbar').attr('sid');
        if ($this.hasClass('selected')) {
            // remove
            removeFavor(sid, function() {
                $('#favor').attr('loaded', 'false');
                $('#add-to-favor').removeClass('selected');
            });
        } else {
            // add
            $.ajax({
                url: '<?php echo $this->url(array(), 'api-favourite-add') ?>',
                data: {sid: sid},
                type: 'post',
                dataType: 'json',
                success: function(response) {
                    if (response.code === 200) {
                        $this.addClass('selected');
                        $('#favor').attr('loaded', 'false');
                    }
                }
            });
        }
    });

    $('#btn-toggle-audio, #btn-toggle-video').click(function() {
        var mode = $(this).attr('rel');
        switchMode(mode);
        var bean = $('#tv-listbar').attr('sid') + ';' + $('.tv-tab-content-body .list-item.selected').attr('id') + ';' + PLAYER.currentTime;
        localStorage.setItem('switch-mode', bean);
    });
    $(document).ready(function() {
        var ls = localStorage.getItem('switch-mode');
        if (ls) {
            var lss = ls.split(';');
            if (lss[0] === $('#tv-listbar').attr('sid') && lss[1] === $('.tv-tab-content-body .list-item.selected').attr('id')) {
                seek(null, parseFloat(lss[2]));
                localStorage.getItem('switch-mode', null);
            }
        }
    });

    $('.hide-qrcode').click(function() {
        var container = $(this).hide().closest('.sharing-popup');
        container.find('.cts-2').animate({
            left: '100%'
        }, 200, 'linear');
    })

    function switchMode(mode) {
        var data = {'value': mode};
        var url = "<?php echo $this->url(array(), 'user-player-mode') ?>";

        $.ajax({
            url: url,
            data: data,
            dataType: 'json',
            method: 'post',
            success: function(response) {
                if (response.code === 200) {
                    location.reload();
                } else {
                }
            },
            error: function() {
            }
        });
    }

    function removeFavor(sid, callback) {
        $.confirm({
            msg: '确定移除该项收藏吗？',
            confirmCallback: function() {
                $.ajax({
                    url: '<?php echo $this->url(array(), 'api-favourite-remove') ?>',
                    data: {sid: sid},
                    type: 'post',
                    dataType: 'json',
                    success: function(response) {
                        if (response.code === 200) {
                            if (typeof callback === 'function')
                                callback();
                        }
                    }
                });
            },
            containerBoxSelector: '#tv'
        });
    }

<?php if ($player_mode == 'audio'): ?>
        // rotate the disk
        var __DURATION = 20000;
        $(document).ready(function() {
            $.rotateDiv(false, '#tv-disk-page', __DURATION);
            setInterval(function() {
                $.rotateDiv(false, '#tv-disk-page', __DURATION);
            }, __DURATION);

        });
<?php endif; ?>


    function needLogin() {
        msg = '<?php
if ($this->message != "") {
    echo $this->message;
}
?>';

        if (msg != '')
            alert(msg);
    }

    needLogin();
</script>

