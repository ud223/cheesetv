<?php
    $player_mode = "video";
    if ($this->me->getUser()->attribute && $this->me->getUser()->attribute['player_mode']) {
        $player_mode = $this->me->getUser()->attribute['player_mode'];
    }
    
?>
<div id="tv-footer" style="display:none">

    <!--    <div id="tv-footer-ltbar">
            <div class="wp">
                <button class="ico" id="prev" class="pull-left"></button>
                <button class="ico" id="play" class="pull-left"></button>
                <button class="ico" id="pause" class="pull-left"></button>
                <button class="ico" id="next" class="pull-left"></button>
            </div>
        </div>-->
    <div id="tv-footer-rtbar">
        <div class="wp">
            <!--            <div id="volume-ctrl" class="pull-left">
                            <button id="volume-speaker" class="ico pull-left"></button>
                            <div id="volume-holder" class="pull-left">
                                <div id="volume-in"></div>
                            </div>
                        </div>-->
            <!--<button id="tv-listbtn" class="ico"></button>-->
        </div>
    </div>

    <div id="tv-footer-mdbar">

        <div id="tv-prog">
            <!--            <div id="tv-prog-timer">
                            <span id="t1">--:--</span><span id="t2">/</span><span id="t3">--:--</span>
                        </div>-->
            <!--            <div id="tv-prog-title">
                        </div>-->
            <!--            <div id="tv-prog-seekbar" class="rr"></div>
                        <div id="tv-prog-loaded" class="rr"></div>-->
        </div>
    </div>
</div>

<div id='tv-sider'>
    <div id='tv-toggle'>
        <a href="javascript:void(0)" rel="video" title="看电视" id="tv-toggle-video-btn" class='tv-toggle-unit bt-go'><i></i></a>
        <a href="javascript:void(0)" rel="audio" title="听声音" id="tv-toggle-audio-btn" class='tv-toggle-unit bt-go'><i></i></a>
    </div>
    <button id='btn-refresh'>换一波</button>
    <div class="clear"></div>
</div>

<div id="tv-main-container" class="layer">

    <div id="tv-listbar">
        <div id="tv-listbar-title">
            <a href="javascript:void(0)" id="tv-author-img"></a>
            <div class="wp">
                <div id="tvidx02">
                    <p id="tv-special-name">
                    </p>
                    <span id="tvidx01">By </span><a id="tv-author-name" href="javascript:void(0)"></a>
                </div>
                <button class="empty-btn close-btn" id="tv-listbar-close"></button>
            </div>
        </div>
        <div id="tv-listbar-content">
        </div>
    </div>

    <div id="tv-screen" class="layer text-center">
        <video id="tv-video-player" preload oncontextmenu="return false;">
            <source>
        </video>
        <audio id="tv-audio-player" preload oncontextmenu="return false;">
        </audio>
    </div>
    <div id="tv-prog-title">
        <span class="tt"></span>
        <div id="tv-prog-timer">
            <span id="t1">--:--</span><span id="t2">/</span><span id="t3">--:--</span>
        </div>
    </div>
    <div id="tv-ctrl-block">
        <div style="padding:10px;">
            <button class="ico pull-left" id="tv-listbtn"></button>
            <button class="ico pull-left" id="prev"></button>
            <button class="ico pull-left" id="play"></button>
            <button class="ico pull-left" id="pause"></button>
            <button class="ico pull-left" id="next"></button>
            <span class="ico pull-left" id="tv-spk">
                <div id="tv-spk-bar">
                    <div id="tv-spk-bar-prog">
                        <div id="tv-spk-bar-prog-loaded">

                        </div>
                    </div>
                </div>
            </span>
            <div class="clear"></div>
        </div>
    </div>

    <!--    <div id="tv-cover" class="layer">
            <button id="tv-fs-play-btn" class="empty-btn"></button>
            <button id="tv-fs-pause-btn" class="empty-btn"></button>
        </div>-->
    <!--    <div id="tv-audio-holder" style="position:absolute;width:600px;height:600px;background:url(/img/cd.png);left:50%;top:50%;margin-left:-300px;margin-top:-300px;">
            <div id="tv-mask" style="background-size:cover;background-position:center center;position:absolute;border-radius:1000px;width:350px;height:350px;left:50%;top:50%;margin-left:-175px;margin-top:-175px;">
    
            </div>
        </div>-->
</div>

<div class="P_tmp">
    <ul class="list-item itm">
        <li class="col col1">
            <i class="ico null"></i>
        </li>
        <li class="col col2 tv-current-title">

        </li>
        <li class="col col3">
            time here
        </li>
    </ul>
</div>

<input type="hidden" id="uid" value="<?php echo $this->uid ?>"/>

<script type="text/javascript">
    var init_player_mode = '<?php echo $player_mode; ?>';
    
    $('document').ready(function() {
        $('.tv-toggle-unit[rel="' + init_player_mode + '"]').addClass('selected');

        // 网速失速
        $('#player').on('stalled', function() {
            console.log('stalled');
            var new_one = $('#player').clone(true);
            $('#player').after(new_one).remove();
        });
        // 网速错误
        $('#player').on('error', function() {
            console.log('error');
            var new_one = $('#player').clone(true);
            $('#player').after(new_one).remove();
        });

        $('#tv-listbtn').click(function() {
            $('#tv-listbar').clickToggle();
        });

        var list = [
            {htmlObject: $('#tv-header')},
            {htmlObject: $('#tv-sider')},
            {htmlObject: $('#tv-ctrl-block')},
            {htmlObject: $('#tv-prog-title')}
        ];
        $('#tv-header, #tv-sider, #tv-ctrl-block, #tv-listbar').mouseenter(function() {
            $.autoToggleListStop();
        });
        $('#tv-header, #tv-sider, #tv-ctrl-block, #tv-listbar').mouseleave(function() {
            $.autoToggleListRestart();
        });
        $.autoToggleList(list);

        $('#tv-screen').video({
            onPause: function() {
                $('#tv-fs-play-btn').show();
                $('#tv-fs-pause-btn').hide();
                $('#play').show();
                $('#pause').hide();
            },
            onEnded: function() {
//                $('#tv-cover').show();
                nextFunc();
            },
            onPlay: function() {
                $('#tv-fs-play-btn').hide();
                $('#tv-fs-pause-btn').show();
                $('#play').hide();
                $('#pause').show();
            }
        });

        $('#play').click(function() {
            $('#tv-screen').video("play", function() {
                $('#tv-cover').hide();
            });
        });
        $('#pause').click(function() {
            $('#tv-screen').video("pause", function() {
//                $('#tv-cover').show();
            });
        });
        $('#next').click(function() {
            nextFunc()
        });
        $('#prev').click(function() {
            prevFunc();
        });

        // 显示“换一批”按钮
        $('#tv-header .unvisiable').removeClass('unvisiable');

        $('#btn-refresh').click(function() {
            getApiData(nextFunc);
        });
        
        $('.tv-toggle-unit').click(function() {
            // change class
            var obj = $(this);
            if (!obj.hasClass('selected')) {
                // change player
                // tv-video-player
                
                
                // save mode status
                obj.addClass('selected').siblings('.tv-toggle-unit').removeClass('selected');
                var mode = obj.attr('rel');
                var data = {'value': mode};
                var url = "<?php echo $this->url(array(), 'user-player-mode') ?>";
                $.ajax({
                    url: url,
                    data: data,
                    dataType: 'json',
                    method: 'post',
                    success: function(response) {
                        if (response.code === 200) {
                        } else {
                        }
                    },
                    error: function() {
                    }
                });
            }
            
        });


        var __dura = 10000;
        $.rotateCd = function() {
            $('#tv-mask').animate({
                rotate: '+=360deg'
            }, __dura, 'linear');
        };
        $.rotateCd();
        window.setInterval("$.rotateCd()", __dura);

        getApiData(nextFunc);
    });
    function playFunc(target) {
        target.addClass('selected').find('.ico').removeClass('null').addClass('play');
        target.siblings('.list-item').removeClass('selected').find('.ico').addClass('null');
        var video_url = target.attr('video');
        var audio_url = target.attr('audio');
        var title = target.find('.tv-current-title').html();
        $('#tv-screen').video("restart", function() {
//            $('#tv-cover').hide();
            $('#tv-prog-title .tt').html(title);
        }, video_url);
    }
    function nextFunc() {
        if (playListCount()) {
            playFunc(_getSelectedItem('next'));
        } else {
            return false;
        }
    }
    function prevFunc() {
        if (playListCount()) {
            playFunc(_getSelectedItem('prev'));
        } else {
            return false;
        }
    }
    function _getSelectedItem(direction) {
        var selected = null;
        var current = $('#tv-listbar-content .list-item.selected');
        var jumpOne;
        if (direction === 'next') {
            jumpOne = $($('#tv-listbar-content .list-item').get(0));
        } else if (direction === 'prev') {
            jumpOne = $($('#tv-listbar-content .list-item').get($('#tv-listbar-content .list-item').length - 1));
        }
        if (current.length) {
            var one;
            if (direction === 'next')
                one = current.next('.list-item');
            else if (direction === 'prev')
                one = current.prev('.list-item');
            if (one.length) {
                selected = one;
            } else {
                selected = jumpOne;
            }
        } else {
            selected = jumpOne;
        }
        return selected;
    }

    function switchFunc() {
        
    }
    function playListCount() {
        var list_item = $('#tv-listbar-content .list-item');
        if (list_item.length) {
            return list_item.length;
        } else {
            return false;
        }
    }

    <?php
      $url = $this->url(array("uid" => $this->uid, "sid" => "none"), "api-special-recommend");
    ?>

    var tmpUrl = "<?php echo $url ?>";
    var myUrl = tmpUrl;

    
    function getApiData(callback) {
        $.ajax({
            url: myUrl,
            dataType: 'json',
            
            success: function(result) {
                if (result.code === 200) {
                    myUrl = tmpUrl;
                    myUrl = myUrl.replace('none', result.data.id);

                    $("#tv-special-name").html(result.data.name);
                    $("#tv-author-name").html(result.data.author);
                    $("#tv-author-img").css('background-image', 'url(' + result.data.photo + ')');
                    $("#tv-listbar-content").empty();
                    $('#tv-mask').css('background-image', 'url(' + result.data.photo_main + ')');
                    $.each(result.data.programs, function() {
                        var item = $(".P_tmp .list-item").clone(true);
                        item.click(function() {
                            playFunc($(this).closest('.list-item'));
                        });
                        item.attr('video', this.oss_video);
                        item.attr('audio', this.oss_audio);
                        item.attr('id', this.id);
                        item.find('.col2').html(this.name);
                        item.find('.col3').html(parseInt(this.time).timeFormat());
                        $("#tv-listbar-content").append(item);
                    });
                    
                    if (typeof callback === 'function') {
                        callback();
                    }
                    
                }
            }
        });
    }
   
</script>
