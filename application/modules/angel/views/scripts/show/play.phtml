<?php
$player_mode = "video";
if ($this->me->getUser()->attribute && $this->me->getUser()->attribute['player_mode']) {
    $player_mode = $this->me->getUser()->attribute['player_mode'];
}
?>
<div id="tv-footer" style="display:none">

    <div id="tv-footer-rtbar">
        <div class="wp">
        </div>
    </div>

</div>



<div id="tv-main-container" class="layer">
    <div id='tv-sider'>
        <div class="pxt">
            <button id='btn-list' class='ico tv-side-btn'></button>
            <button id='btn-refresh' class='ico tv-side-btn'></button>
            <button id='btn-toggle' class='ico tv-side-btn'></button>
        </div>
    </div>


    <div id="tv-screen" class="layer text-center">

        <video id="tv-video-player" preload oncontextmenu="return false;">
            <source>
        </video>
    </div>

    <div id="tv-ctrl-block">
        <div id="tv-ctrl-c">
            <div id="tv-ctrl-prog">

            </div>
        </div>
        <div id="tv-ctrl-play" class="tv-ctrl-s">
            <i class="ico"></i>
        </div>
        <div id="tv-ctrl-fullscreen" full='no' class="tv-ctrl-s">
            <i class="ico"></i>
        </div>
    </div>

</div>

<div class="P_tmp">
    <ul class="list-item itm">
        <li class="col col1">
            <i class="ico null"></i>
        </li>
        <li class="col col2 tv-current-title">

        </li>
        <li class="col col3">
            time here
        </li>
    </ul>
</div>



<!--<button id="seeking-testing-btn" style="position:fixed;z-index:100;bottom:100px;left:100px;padding:10px;">SEEKING BTN</button>-->

<input type="hidden" id="uid" value="<?php echo $this->uid ?>"/>

<script type="text/javascript">
    var init_player_mode = '<?php echo $player_mode; ?>';

    $('document').ready(function() {

        $('.tv-toggle-unit[rel="' + init_player_mode + '"]').addClass('selected');
        if (init_player_mode === 'audio') {
            $('#tv-video-player').addClass('move-away');
            $('body').data('auto-toggle-list-switch', 'off');
        }

        // 网速失速
        $('#player').on('stalled', function() {
            console.log('stalled');
            var new_one = $('#player').clone(true);
            $('#player').after(new_one).remove();
        });
        // 网速错误
        $('#player').on('error', function() {
            console.log('error');
            var new_one = $('#player').clone(true);
            $('#player').after(new_one).remove();
        });


        var list = [
            {htmlObject: $('#tv-sider')},
            {htmlObject: $('#tv-ctrl-block')}
        ];

        $.autoToggleList(list);

        $('#tv-screen').video({
            onPause: function() {
            },
            onEnded: function() {
                nextFunc();
            },
            onPlay: function() {
            }
        });


        $('#btn-refresh').click(function() {

            $.waiting('一大波精彩节目正在向您走来 ...', $('#tv'));
            var callback = function(response) {
                var msg = '<p>推送新专辑</p>';
                msg += '<p style="color:#FFD800">' + response.data.name + '</p>';
                msg += '<p style="opacity:0.5">作者：' + response.data.author + '</p>';
                setTimeout(function() {
                    $.endWaiting();
                    var options = {
                        msg: msg,
                        confirmText: '立即收看',
                        width: 500,
                        height: 'auto',
                        cancelText: '换一波',
                        containerBoxSelector: '#tv',
                        cancelCallback: function() {
                            $('#btn-refresh').click();
                        },
                        confirmCallback: function() {
                            installList(response);
                            nextFunc();
                        }
                    };
                    $.confirm(options);
                    console.log(response);
//                    nextFunc
                }, 2500);
            }
            // "endWaiting" in "callback"
            getApiData(callback, true);
        });

        $('.tv-toggle-unit').click(function() {
            // change classr
            var obj = $(this);
            if (!obj.hasClass('selected')) {
                $.waiting('正在为您切换 ...');
                setTimeout(function() {
                    // change player ui
                    $('#tv-video-player').toggleClass('move-away');
                    if (obj.attr('rel') === 'audio') {
                        $('body').data('auto-toggle-list-switch', 'off');
                    } else {
                        $('body').data('auto-toggle-list-switch', 'on');
                    }
                    // save mode status
                    obj.addClass('selected').siblings('.tv-toggle-unit').removeClass('selected');
                    var mode = obj.attr('rel');
                    var data = {'value': mode};
                    var url = "<?php echo $this->url(array(), 'user-player-mode') ?>";

                    $.ajax({
                        url: url,
                        data: data,
                        dataType: 'json',
                        method: 'post',
                        success: function(response) {
                            if (response.code === 200) {
                            } else {
                            }
                        },
                        error: function() {
                        }
                    });
                    // change url path
                    continuePlayFunc();
                    $.endWaiting();
                }, 3000);

            }
        });

        getApiData(nextFunc);

    });
    function playFunc(target, delayPlay) {
        var playing = $('.list-item.selected');

        if (playing.length) {
            // send keyword preference here
            var duration = $('#tv-screen').video("duration");
            var currentTime = $('#tv-screen').video("currentTime");
            var pid = playing.attr('id');

            var tmpPer = currentTime / duration * 100;
            var per = Math.floor(tmpPer);

<?php
$url = $this->url(array(), "api-keyword-vote");
?>

            var url = '<?php echo $url ?>';
            var data = {'time': per, 'pid': pid};

            $.ajax({
                url: url,
                dataType: 'json',
                data: data,
                method: 'post',
                success: function(response) {
//                    alert(response.code);
                },
                error: function() {
                    $.endWaiting();
                }
            });
        }

        target.addClass('selected').find('.ico').removeClass('null').addClass('play');
        target.siblings('.list-item').removeClass('selected').find('.ico').addClass('null');
        var video_url = target.attr('video');
        var audio_url = target.attr('audio');
        var url = video_url;
        if ($('.tv-toggle-unit.selected').attr('rel') === 'audio')
            url = audio_url;
        var title = target.find('.tv-current-title').html();
        $('#tv-screen').video("restart", function() {
//            $('#tv-cover').hide();
        }, url, delayPlay);
    }
    function continuePlayFunc() {
        var target = $('.list-item.itm.selected');
        var video_url = target.attr('video');
        var audio_url = target.attr('audio');
        var url = video_url;
        if ($('.tv-toggle-unit.selected').attr('rel') === 'audio')
            url = audio_url;
        var currentTime = $('#tv-screen').video("currentTime");
        $('#tv-screen').video("restart", false, url);
        $('#tv-screen').video("seek", false, currentTime);
    }
    function nextFunc() {
        if (playListCount()) {
            playFunc(_getSelectedItem('next'));
        } else {
            return false;
        }
    }
    function prevFunc() {
        if (playListCount()) {
            playFunc(_getSelectedItem('prev'));
        } else {
            return false;
        }
    }
    function _getSelectedItem() {
        // refer
    }

    function switchFunc() {

    }
    function playListCount() {
        // refer
    }

<?php
$url = $this->url(array("uid" => $this->uid, "sid" => "none"), "api-special-recommend");
$uid = $this->uid;
?>
    var userId = "<?php echo $uid ?>";
    var tmpUrl = "<?php echo $url ?>";
    var myUrl = tmpUrl;

    function installList(response) {
        if (response.data.programs) {
            $.each(response.data.programs, function() {
                var item = $(".P_tmp .list-item").clone(true);
                item.click(function() {
                    playFunc($(this).closest('.list-item'));
                });
                item.attr('video', this.oss_video);
                item.attr('audio', this.oss_audio);
                item.attr('id', this.id);
                item.find('.col2').html(this.name);
                item.find('.col3').html(parseInt(this.time).timeFormat());
            });
        }
    }
    function getApiData(callback, installListInCallback) {
        $('#tv-screen').video('pause');
        $.ajax({
            url: myUrl,
            dataType: 'json',
            success: function(response) {
                if (response.code === 200) {
                    myUrl = tmpUrl;
                    myUrl = myUrl.replace('none', response.data.id);
                    if (!installListInCallback) {
                        // execute installList now;
                        installList(response);
                    }
                    // else execute installList in callback;
                    if (typeof callback === 'function') {
                        callback(response);
                    }
                }
            },
            error: function() {
                $.endWaiting();
            }
        });
    }
</script>

<style>
    .move-away {
        position:fixed;
        left:100000px;
    }
</style>
